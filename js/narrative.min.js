function get_path(t){var n=t.x0,e=t.x1,r=d3.interpolateNumber(n,e),i=r(curvature),a=r(1-curvature),o=t.y0,s=t.y1;return"M"+n+","+o+"C"+i+","+o+" "+a+","+s+" "+e+","+s}function Character_(t,n,e){this.name=t,this.id=n,this.group=e,this.group_ptr=null,this.first_scene=null,this.group_positions={},this.group_name_positions={}}function Link(t,n,e,r){this.from=t,this.to=n,this.char_id=r,this.group=e,this.x0=0,this.y0=-1,this.x1=0,this.y1=-1,this.char_ptr=null}function SceneNode(t,n,e,r){this.chars=t,this.start=n,this.duration=e,this.id=r,this.char_ptrs=[],this.x=0,this.y=0,this.width=node_width,this.height=0,this.in_links=[],this.out_links=[],this.name="",this.has_char=function(t){for(var n=0;n<this.chars.length;n++)if(t==this.chars[n])return!0;return!1},this.char_node=!1,this.first_scene=null,this.median_group=null,this.comic_name}function reposition_node_links(t,n,e,r,i,a,o,s){var h=0;d3.selectAll('[to="'+s+"_"+t+'"]').each(function(t){t.x1=n+r/2,t.y1-=o,h+=1}).attr("d",function(t){return get_path(t)}),h=0,d3.selectAll('[from="'+s+"_"+t+'"]').each(function(t){t.x0=n+r/2,t.y0-=o,h+=1}).attr("d",function(t){return get_path(t)})}function generate_links(t,n){for(var e=[],r=0;r<t.length;r++){for(var i=[],a=0;a<n.length;a++)n[a].has_char(t[r].id)&&(i[i.length]=n[a]);i.sort(function(t,n){return t.start-n.start}),t[r].first_scene=i[0];for(var a=1;a<i.length;a++)e[e.length]=new Link(i[a-1],i[a],t[r].group,t[r].id),e[e.length-1].char_ptr=t[r],i[a-1].out_links[i[a-1].out_links.length]=e[e.length-1],i[a].in_links[i[a].in_links.length]=e[e.length-1]}return e}function Group(){this.min=-1,this.max=-1,this.id=-1,this.chars=[],this.first_scene_chars=[],this.median_count=0,this.biggest_scene=0,this.all_chars={},this.char_scenes=[],this.order=-1}function sort_groups(t,n,e,r){if(2==n.length)return t[r]=n[0],void(t[e]=n[1]);if(e>=r)return void(n.length>0&&(t[e]=n[0]));var i=Math.floor((e+r)/2);t[i]=n[0];for(var a=e,o=i-1,s=i+1,h=r,c=[],l=[],u=1;u<n.length;u++)u%2==0?c[c.length]=n[u]:l[l.length]=n[u];sort_groups(t,c,a,o),sort_groups(t,l,s,h)}function define_groups(t){var n=[];return t.forEach(function(t){var e=!1;n.forEach(function(n){n.id==t.group&&(e=!0,n.chars[n.chars.length]=t,t.group_ptr=n)}),e||(g=new Group,g.id=t.group,g.chars[g.chars.length]=t,t.group_ptr=g,n[n.length]=g)}),n}function find_median_groups(t,n,e,r,i){n.forEach(function(n){if(!n.char_node){for(var r=[],a=0;a<t.length;a++)r[a]=0;var o=0;n.chars.forEach(function(a){var s=find_group(e,t,a);if(r[s]+=1,!i&&r[s]>=r[o]||r[s]>r[o])o=s;else if(r[s]==r[o]){for(var h=0,c=0,l=0;l<n.in_links.length;l++)null!=n.in_links[l].from.median_group&&(n.in_links[l].from.median_group.id==t[s].id?h+=1:n.in_links[l].from.median_group.id==t[o].id&&(c+=1));for(var l=0;l<n.out_links.length;l++)null!=n.out_links[l].to.median_group&&(n.out_links[l].to.median_group.id==t[s].id?h+=1:n.out_links[l].to.median_group.id==t[o].id&&(c+=1));h>c&&(o=s)}}),n.median_group=t[o],t[o].median_count+=1,n.chars.forEach(function(n){t[o].all_chars[n]=!0})}}),t.forEach(function(t){chars_list=[];for(var n in t.all_chars)chars_list.push(r[n]);t.all_chars=chars_list})}function sort_groups_main(t,n){t.sort(function(t,n){return n.median_count-t.median_count});for(var e=[],r=0;r<t.length;r++)e[r]=t[r];if(n){var i=Math.floor(t.length/2);e[i]=t[0];for(var a=[],r=0;r<i;r++)a[r]=t[r];for(var o=[],r=i+1;r<t.length;r++)o[r-i-1]=t[r];sort_groups(e,a,0,i),sort_groups(e,o,i+1,t.length)}else if(t.length>0&&(e[0]=t[0]),t.length>1&&(e[t.length-1]=t[1]),t.length>2){for(var s=[],r=0;r<t.length-2;r++)s[r]=t[r+2];sort_groups(e,s,1,t.length-2)}for(var r=0;r<e.length;r++)e[r].order=r;return e}function add_char_scenes(t,n,e,r,i,a){var o=[];n.forEach(function(t){equal_scenes||(t.start+=i)});var s=0;r.forEach(function(t){var n=t.all_chars.length*text_height;t.min=s,t.max=t.min+n,s+=n+group_gap});for(var h=0;h<t.length;h++){var c=new SceneNode([t[h].id],[0],[1]);if(c.char_node=!0,c.y=h*text_height,c.x=0,c.width=5,c.height=link_width,c.name=t[h].name,c.chars[c.chars.length]=t[h].id,c.id=n.length,c.comic_name=a,null!=t[h].first_scene){var l=new Link(c,t[h].first_scene,t[h].group,t[h].id);l.char_ptr=t[h],c.out_links[c.out_links.length]=l,t[h].first_scene.in_links[t[h].first_scene.in_links.length]=l,e[e.length]=l,c.first_scene=t[h].first_scene,n[n.length]=c,o[o.length]=c,c.median_group=t[h].first_scene.median_group}}return o}function find_group(t,n,e){var r;for(r=0;r<t.length&&t[r].id!=e;r++);r==t.length&&console.log("ERROR: char not found, id = "+e);var i;for(i=0;i<n.length&&t[r].group!=n[i].id;i++);return i==n.length&&console.log("ERROR: groups not found."),i}function calculate_node_positions(t,n,e,r,i,a,o,s,h,c){n.forEach(function(t){if(!t.char_node){t.height=Math.max(0,t.chars.length*link_width+(t.chars.length-1)*link_gap),t.width=3*s;for(var n=0,e=0,r=0,i=0,a=0;a<t.chars.length;a++){var o=c[t.chars[a]],h=o.group_positions[t.median_group.id];h&&(o.group.id==t.median_group.id?(n+=h,r+=1):(e+=h,i+=1))}var l;0!=i?l=e/i:0!=r?l=n/r:(console.log("ERROR: den1 and den2 are 0. Scene "+t.id+" doesn't have characters?"),l=t.median_group.min),t.y=l-t.height/2,equal_scenes?t.x=t.start:t.x=t.start*s}}),a.forEach(function(t){null!=t.first_scene&&(t.first_scene.x>per_width*raw_chart_width?t.x=t.first_scene.x-name_shift:t.x=h*s-name_shift)})}function calculate_link_positions(t,n,e,r){t.forEach(function(t){t.in_links.sort(function(t,n){return t.char_ptr.group_ptr.order-n.char_ptr.group_ptr.order}),t.out_links.sort(function(t,n){return t.char_ptr.group_ptr.order-n.char_ptr.group_ptr.order});for(var n=0;n<t.out_links.length;n++)t.out_links[n].y0=-1;for(var e=0,n=0;n<t.in_links.length;n++)t.in_links[n].y1=t.y+n*(link_width+link_gap)+link_width/2,t.in_links[n].x1=t.x+.5*t.width,e<t.out_links.length&&t.out_links[e].char_id==t.in_links[n].char_id&&(t.out_links[e].y0=t.in_links[n].y1,e++);for(var n=0;n<t.out_links.length;n++)t.out_links[n].y0==-1&&(t.out_links[n].y0=t.y+n*(link_width+link_gap)+link_width/2),t.out_links[n].x0=t.x+.5*t.width})}function draw_nodes(t,n,e,r,i,a){function o(t){if(1!=t.char_node){var a=new Image;a.name="Scene panel",a.id="scene"+t.id,a.src=i+"/scene_images/scene"+t.id+".png",a.onload=function(i){var a=this.width,o=this.height,s=t.x+t.width,h=t.y+t.height;if(o>r-h){var c=Math.max(h,r-h);if(o>c){var l=c/o;o*=l,a*=l}c==h&&(h-=o+t.height)}if(a>e-s){var u=Math.max(s,e-s);if(a>u){var l=u/a;o*=l,a*=l}u==s&&(s-=a+t.width)}n.append("image").data([this]).attr("x",s).attr("y",h).attr("xlink:href",this.src).attr("transform",null).style("position","relative").attr("id",this.id).attr("class","scene-image").attr("width",a).attr("height",o)}}}function s(t){d3.selectAll('[class="scene-image"]').remove()}function h(t){var i=Math.max(0,Math.min(r-t.height,d3.event.y)),a=t.y-i;d3.select(this).attr("transform","translate("+(t.x=Math.max(0,Math.min(e-t.width,d3.event.x)))+","+(t.y=Math.max(0,Math.min(r-t.height,d3.event.y)))+")"),reposition_node_links(t.id,t.x,t.y,t.width,t.height,n,a,t.comic_name)}var c=n.append("g").selectAll(".node").data(t).enter().append("g").attr("class","node").attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).attr("scene_id",function(t){return t.id}).on("mouseover",o).on("mouseout",s).call(d3.behavior.drag().origin(function(t){return t}).on("dragstart",function(){this.parentNode.appendChild(this)}).on("drag",h));c.append("rect").attr("width",function(t){return t.width}).attr("height",function(t){return t.height}).attr("class","scene").attr("rx",20).attr("ry",10).append("title").text(function(t){return t.name}),name_bg&&c.append("rect").filter(function(t){return t.char_node}).attr("x",function(t){return-(5*(t.name.length+2))}).attr("y",function(t){return-3}).attr("width",function(t){return 5*(t.name.length+1)}).attr("height",7.5).attr("transform",null).attr("fill","#fff").style("opacity",1),c.append("text").filter(function(t){return t.char_node}).attr("x",-6).attr("y",function(t){return 0}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(t){return t.name}).filter(function(t){return!1}).attr("x",function(t){return 6+t.width}).attr("text-anchor","start")}function find_link(t,n){for(var e=0;e<t.length;e++)if(t[e].char_id==n)return t[e];return 0}function draw_links(t,n,e){function r(t){d3.selectAll('[charid="'+t.from.comic_name+"_"+t.char_id+'"]').style("stroke-opacity","1")}function i(t){d3.selectAll('[charid="'+t.from.comic_name+"_"+t.char_id+'"]').style("stroke-opacity","0.6")}var a=n.append("g").selectAll(".link").data(t).enter().append("path").attr("class","link").attr("d",function(t){return get_path(t)}).attr("from",function(t){return t.from.comic_name+"_"+t.from.id}).attr("to",function(t){return t.to.comic_name+"_"+t.to.id}).attr("charid",function(t){return t.from.comic_name+"_"+t.char_id}).style("stroke",function(t){return d3.rgb(color(t.group)).darker(.5).toString()}).style("stroke-width",link_width).style("stroke-opacity","0.6").style("stroke-linecap","round").on("mouseover",r).on("mouseout",i)}function draw_chart(t,n,e,r,i,a){raw_chart_width=$("#xkcdChart").width(),d3.json(e+"/narrative.json",function(a){for(var o={top:20,right:25,bottom:20,left:1},s=raw_chart_width-o.left-o.right,h=a.scenes,c=(s-longest_name)/(h.length+1),l=0,u=[],d=0;d<h.length;d++){var _=parseInt(h[d].duration),g;g=equal_scenes?d*c+longest_name:parseInt(h[d].start);var f=h[d].chars;u[u.length]=new SceneNode(h[d].chars,g,_,parseInt(h[d].id)),u[u.length-1].comic_name=n,l+=_}u.sort(function(t,n){return t.start-n.start}),l-=u[u.length-1].duration,u[u.length-1].duration=0;var p=Math.min((s-longest_name)/l,15),m=Math.round(longest_name/p);l+=m,p=Math.min(s/l,15),d3.xml(e+"/characters.xml",function(a){for(var h=read_chars(a),c=360,d=c-o.top-o.bottom,_=d3.select("#xkcdChart").append("text").attr("x",0).attr("y",0).attr("dy",".35em").attr("text-anchor","end").attr("class","comic-title").attr("transform",null).attr("id",n).text(" - "+t).data([{name:" - "+t,folder:e,safe_name:n}]).style("display","block").on("click",function(t){for(var n=d3.selectAll(".chart").selectAll('[id="'+t.safe_name+'"]'),e,r=0;r<n.length;r++)if(n[r].parentNode.id==t.safe_name){e=n[r].parentNode;break}"-"==t.name[1]?(e.style.display="none",t.name=t.name.replace("-","+")):(e.style.display="inherit",t.name=t.name.replace("+","-")),d3.select(this).text(t.name)}),_=d3.select("#xkcdChart").append("svg").attr("width",s+o.left+o.right).attr("height",d+o.top+o.bottom).attr("class","chart").attr("id",n).append("g").attr("transform","translate("+o.left+","+o.top+")"),g=[],f=[],v=0;v<h.length;v++)g[g.length]=new Character_(h[v].name,h[v].id,h[v].group),f[h[v].id]=g[g.length-1];var k=define_groups(g);find_median_groups(k,u,g,f,r),k=sort_groups_main(k,i);var x=generate_links(g,u),y=add_char_scenes(g,u,x,k,m,n);k.forEach(function(t){t.all_chars.sort(function(t,n){return t.group_ptr.order-n.group_ptr.order});for(var n=t.min,e=0;e<t.all_chars.length;e++)t.all_chars[e].group_positions[t.id]=n+e*text_height}),calculate_node_positions(g,u,l,s,d,y,k,p,m,f),u.forEach(function(t){if(!t.char_node){first_scenes=[],t.in_links.forEach(function(t){t.from.char_node&&(first_scenes[first_scenes.length]=t.from)});for(var n=0;n<first_scenes.length;n++)first_scenes[n].y=t.y+t.height/2+n*text_height}}),y.forEach(function(t){var n=f[t.chars[0]];if(n.first_scene.x<per_width*s){var e=n.first_scene.median_group;t.y=n.group_positions[e.id]}}),calculate_link_positions(u,g,k,f),d=k[k.length-1].max+5*group_gap,c=d+o.top+o.bottom,d3.select("svg#"+n).style("height",c),draw_links(x,_),draw_nodes(u,_,s,d,e,c,n)})})}function get_xml(t){var n=new XMLHttpRequest;return n.open("GET",t,!1),n.send(),200===n.status?n.responseXML:void alert("ERROR: Couldn't retrieve xml at "+t+"; error status: "+n.status)}function get_attribute(t,n,e){var r=t.getAttribute(n);return null==r?e:r}function number_to_name(t,n){for(var e=t.toString(),r=e.length;r<n.pad_to;)e="0"+e,r+=1;var i=e;return"prepend"==n.path_creation?i=n.basename+i:"append"==n.path_creation&&(i+=n.basename),i}function ComicOptions(t){var n=get_xml(t+"/options.xml"),e=n.getElementsByTagName("folder-options")[0];this.basename=e.attributes.getNamedItem("basename").nodeValue,this.pad_to=e.attributes.getNamedItem("number-padding").nodeValue,this.path_creation=e.attributes.getNamedItem("path-creation").nodeValue,this.first_page=e.attributes.getNamedItem("first-page").nodeValue,this.ext=e.attributes.getNamedItem("ext").nodeValue}function Transition(t){this.from=parseInt(t.attributes.getNamedItem("from-id").nodeValue),this.to=parseInt(t.attributes.getNamedItem("to-id").nodeValue),this.type=parseInt(t.attributes.getNamedItem("type").nodeValue)}function Vertex(t,n){this.x=t,this.y=n}function Character(t){this.name=t.getAttribute("name"),this.id=parseInt(t.getAttribute("id")),this.group=parseInt(t.getAttribute("group"))}function TagDef(t){this.name=t.getAttribute("name"),this.id=parseInt(t.getAttribute("id")),this.description=get_attribute(t,"description","")}function Tag(t){this.id=parseInt(t.getAttribute("id")),this.confidence=parseInt(get_attribute(t,"confidence",10)),this.intensity=parseInt(get_attribute(t,"intensity",10))}function read_chars(t){var n=t.getElementsByTagName("character");characters=[];for(var e=0;e<n.length;e++)characters[e]=new Character(n[e]);return characters}var link_width=1.8,link_gap=2,node_width=10,color=d3.scale.category10(),raw_chart_width=1e3,group_gap=0,text_height=8,per_width=.3,name_shift=10,name_bg=!0,equal_scenes=!1,curvature=.5,sw_panels=3,longest_name=115;