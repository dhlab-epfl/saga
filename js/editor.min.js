function closeOverlay(){$("#overlay").fadeOut()}var GRAPHS,EDITOR,PROJECT,GRAPHS={updateCharsGraph:function(){d3.selectAll("svg.charsGraph > *").remove();var t=d3.select("svg.charsGraph"),e=$("#charsGraph").width(),a=$("#charsGraph").height(),n=d3.fisheye.circular().radius(a/3).distortion(4),r=$("#charsGraph .double.range .label:nth-child("+GRAPHS.rangeStartIdx+")").attr("data-cvalue"),i=$("#charsGraph .double.range .label:nth-child("+GRAPHS.rangeEndIdx+")").attr("data-cvalue");d3.json("_.php?f=getCharsGraph&includeNonColored="+$("#cbIncludeNonColored:checked").length+"&seq_start="+r+"&seq_end="+i,function(r,i){function o(){s.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),d.attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("fill",function(t){return t.color})}if(r)throw r;if(i.nodes.length>1&&i.links.length>0){var l=Math.sqrt(i.nodes.length/(e*a)),c=d3.forceSimulation().force("link",d3.forceLink().id(function(t){return t.id})).force("charge",d3.forceManyBody().strength(-(1/l)).distanceMax(50)).force("center",d3.forceCenter(e/2,a/2)),s=t.append("g").attr("class","links").selectAll("line").data(i.links).enter().append("line").attr("stroke-width",function(t){return Math.sqrt(t.value)}),d=t.selectAll(".mytext").data(i.nodes).enter().append("text").text(function(t){return t.id}).style("text-anchor","middle").style("stroke","#999").style("stroke-width",1).style("font-weight","bold").style("font-size",15);c.nodes(i.nodes).on("tick",o),c.force("link").links(i.links),t.on("mousemove",function(){n.focus(d3.mouse(this)),d.each(function(t){t.fisheye=n(t)}).attr("x",function(t){return t.fisheye.x}).attr("y",function(t){return t.fisheye.y}),s.attr("x1",function(t){return t.source.fisheye.x}).attr("y1",function(t){return t.source.fisheye.y}).attr("x2",function(t){return t.target.fisheye.x}).attr("y2",function(t){return t.target.fisheye.y})}),$("#charsGraph .labels>*").remove(),i.chapters.forEach(function(t){$("#charsGraph .labels").append('<li class="label" data-cvalue="'+t+'">'+Math.floor(t/1e3)+"."+t%1e3+"</li>")}),PROJECT.initRangeInputs(GRAPHS.rangeStartIdx,GRAPHS.rangeEndIdx)}})},rangeStartIdx:0,rangeEndIdx:-1,rangeInputChanged:function(){var t=!1,e=$("#charsGraph .double.range").range("get thumb value"),a=$("#charsGraph .double.range").range("get thumb value","second"),n=Math.min(e,a);n!==GRAPHS.rangeStartIdx&&(GRAPHS.rangeStartIdx=n,t=!0);var r=Math.max(e,a);r!==GRAPHS.rangeEndIdx&&(GRAPHS.rangeEndIdx=r,t=!0),t&&GRAPHS.updateCharsGraph()},updateTimelineGraph:function(){d3.selectAll("svg.timelineGraph > *").remove();var t={top:20,right:20,bottom:65,left:80},e=$("#timelineGraph").width()-t.left-t.right,a=$("#timelineGraph").height()-t.top-t.bottom,n=3,r=15;d3.json("_.php?f=getTimelineGraph&includeNonColored="+$("#cbIncludeNonColored:checked").length,function(i,o){if(i)throw i;var l=o.colors,c=Object.keys(o.graph),s=[],d={},u={},p=Math.max(9*c.length,e),h=d3.select("svg.timelineGraph").attr("width",p+t.left+t.right).attr("height",a+t.top+t.bottom).append("g").attr("transform","translate("+t.left+","+t.top+")"),f=d3.scaleLinear().range([0,p]),y=d3.scaleLinear().range([a,0]),v=d3.line().curve(d3.curveCatmullRom.alpha(.7)).x(function(t){return f(t.chapter)}).y(function(t){return y(t.place)}),m=d3.line().curve(d3.curveCatmullRom.alpha(.7)).x(function(t){return f(t.chapter)}).y(function(t){return y(t.place+t.offset)});c.forEach(function(t){var e=o.graph[t];""!==e.place&&e.characters.length>0&&(void 0===u[e.place]&&(u[e.place]=0),u[e.place]+=1,e.characters.forEach(function(t){void 0===d[t]&&(d[t]=[]),d[t].push(e)}))}),s=Object.keys(u),f.domain([0,c.length+1]),h.append("g").attr("class","grid").attr("transform","translate(0,"+a+")").call(d3.axisBottom(f).ticks(c.length).tickSize(-a).tickFormat(function(t){return c[t-1]})).selectAll("text").attr("class","xtick").style("text-anchor","end").attr("dx","-10px").attr("dy","-5px").attr("transform","rotate(-90)").on("click",function(t){EDITOR.openChapter(o.chaptersMap[c[t-1]][0])}),y.domain([0,s.length+1]),h.append("g").attr("class","grid").call(d3.axisLeft(y).ticks(s.length+1).tickSize(-p).tickFormat(function(t){return s[t-1]}));var g=[];c.forEach(function(t){var e=o.graph[t];""!==e.place&&g.push({chapter:1+c.indexOf(t),place:1+s.indexOf(e.place)})}),h.append("path").data([g]).attr("class","story").attr("d",v).attr("stroke-width",a/(s.length+2)).attr("stroke","#000");var x=-.4;Object.keys(d).forEach(function(t){var e=[];x+=.8/(Object.keys(d).length+1),c.forEach(function(a){o.graph[a].characters.indexOf(t)>-1&&e.push({chapter:1+c.indexOf(a),place:1+s.indexOf(o.graph[a].place),offset:x})}),e.length>0&&(h.append("path").data([e]).attr("class","char").attr("d",m).attr("stroke",l[t]),h.selectAll(".dot").data(e).enter().append("circle").attr("r",n).attr("cx",m.x()).attr("cy",m.y()).attr("fill",l[t]),h.selectAll(".dot").data([e[0],e[e.length-1]]).enter().append("rect").attr("width",n).attr("height",r).attr("y",m.y()).attr("x",m.x()).attr("transform","translate(-"+n/2+",-"+r/2+")").attr("fill",l[t]))})})},updateEntityNgram:function(t,e){function a(t){return t.n=+t.n,t}d3.selectAll("svg.entityNgram > *").remove();var n=d3.select("svg.entityNgram"),r={top:20,right:20,bottom:30,left:40},i=$("#entityNgram").width()-r.left-r.right,o=150-r.top-r.bottom,l=d3.scaleBand().rangeRound([0,i]).padding(.1),c=d3.scaleLinear().rangeRound([o,0]),s=n.append("g").attr("transform","translate("+r.left+","+r.top+")");d3.tsv("_.php?f=getEntityNgram&id="+t,a,function(t,a){if(t)throw t;l.domain(a.map(function(t){return t.chapter})),c.domain([0,d3.max(a,function(t){return t.n})]),s.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+o+")").call(d3.axisBottom(l)).selectAll("text").style("text-anchor","end").attr("dx","-10px").attr("dy","-5px").attr("transform","rotate(-90)"),s.append("g").attr("class","axis axis--y").call(d3.axisLeft(c).ticks(10,"%")).append("text").attr("transform","rotate(-90)").attr("y",26).attr("text-anchor","end"),s.selectAll(".bar").data(a).enter().append("rect").attr("class","bar color_"+e).attr("x",function(t){return l(t.chapter)}).attr("y",function(t){return c(t.n)}).attr("width",l.bandwidth()).attr("height",function(t){return o-c(t.n)}).on("click",function(t){EDITOR.openChapter(t.cid)})})},updateIOGraph:function(){function t(t,e,a){var n;for(e=1,n=0;e<a.length;++e)n+=t[a[e]]=+t[a[e]];return t.total=n,t}d3.selectAll("svg.ioGraph > *").remove();var e=d3.select("svg.ioGraph"),a={top:5,right:0,bottom:90,left:20},n=8;d3.tsv("_.php?f=getIOGraph&includeNonColored="+$("#cbIncludeNonColored:checked").length,t,function(t,r){if(t)throw t;var i=r.columns.slice(1),o=Math.max($("#ioGraph").width(),r.length*n+a.left+a.right);e.attr("width",o);var l=o-a.left-a.right,c=$("#ioGraph").height()-a.top-a.bottom,s=e.append("g").attr("transform","translate("+a.left+","+a.top+")"),d=d3.scaleBand().rangeRound([0,l]),u=d3.scaleLinear().rangeRound([c,0]),p=d3.scaleOrdinal(d3.schemeCategory10).range(["#bfbfbf","#ed6a64","#84ad4e"]),h=d3.stack();d.domain(r.map(function(t){return t.chapter})),u.domain([0,d3.max(r,function(t){return t.total})]).nice(),p.domain(i);var f=0;r.forEach(function(t){f=Math.max(t.total,f)}),s.selectAll(".serie").data(h.keys(i)(r)).enter().append("g").attr("class","serie").attr("fill",function(t){return p(t.key)}).selectAll("rect").data(function(t){return t}).enter().append("rect").attr("x",function(t){return d(t.data.chapter)}).attr("y",function(t){return u(t[1])}).attr("height",function(t){return u(t[0])-u(t[1])}).attr("width",d.bandwidth()),s.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+c+")").call(d3.axisBottom(d)).selectAll("text").style("text-anchor","end").style("font-size","9px").attr("dx","-8px").attr("dy","-15px").attr("transform","rotate(-90)"),s.append("g").attr("class","axis axis--y").call(d3.axisLeft(u).ticks(f,"s")).selectAll("text").attr("dy","-5px")})}},EDITOR={openChapter:function(t){$.get("_.php",{f:"getChapterOverlay",id:t},function(e){$("#overlay>.panel>header>h1").html("Éditeur de chapitre"),$("#overlay>.panel>.content").html(e),$("#overlay").fadeIn(),$("#overlay>.panel>.content .editable, #overlay>.panel>.content input[type=text]").on("blur",function(){EDITOR.save(t)}),$("#overlay>.panel>.content .dropdown").dropdown({forceSelection:!1,onChange:function(){EDITOR.save(t)}}),$("#overlay>.panel .infos .ui.label>a").on("click touchdown",function(t){t.stopPropagation(),EDITOR.openEntity($(this).closest(".label").attr("data-id"))}),$("#overlay>.panel .infos .ui.label>i.delete").on("click touchdown",function(t){t.stopPropagation();var e=$(this).parent(".label").attr("data-id"),a=$("#overlay").find(".content>.chapter").attr("data-id");alertify.confirm("Confirmer la suppression?",function(){$.get("_.php",{f:"removeChapterEntity",entity_id:e,chapter_id:a},function(){EDITOR.openChapter(a)})})}),EDITOR.updateStats()})},openEntity:function(t){$.get("_.php",{f:"getEntityOverlay",entity_id:t},function(e){$("#overlay>.panel>header>h1").html("Détails sur l’entité"),$("#overlay>.panel>.content").html(e),$("#overlay").fadeIn(),$("#overlay>.panel>.content .ui.dropdown").dropdown({on:"hover"}),$("#overlay>.panel>.content #bAddCoref").on("click touchdown",function(){var e=$("#overlay>.panel>.content .ui.dropdown").dropdown("get text"),a=$("#overlay>.panel>.content .ui.dropdown").dropdown("get value");""!==e&&alertify.confirm("Confirmer ? L’entité «"+e+"» sera fusionnée avec «"+$("#overlay>.panel>.content .ui.header").text()+"».",function(){$.get("_.php",{f:"mergeEntities",main_id:t,other_id:a},function(){PROJECT.updateEntities(),PROJECT.refreshStory(),EDITOR.openEntity(t)})})}),$("#overlay>.panel>.content .delete.icon").on("click touchdown",function(){var e=$(this).closest(".ui.label").text();alertify.confirm("Confirmer la suppression?",function(){$.get("_.php",{f:"deleteSynonym",entity_id:t,form:e},function(){EDITOR.openEntity(t)})})}),$("#overlay>.panel>.content .editable").on("blur",function(){EDITOR.save(t)}),GRAPHS.updateEntityNgram(t,$("#overlay .colorSelector>.label.active").attr("data-color"))})},updateStats:function(){var t=$(".editor.editable").text(),e=t.replace(/(^\s*)|(\s*$)/gi,"").replace(/[ ]{2,}/gi," ").replace(/\n /,"\n").split(" ").length,a=t.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ").split(".").length-1;$(".chapter #textStats").html(e+" mot"+(e>1?"s":"")+" / "+a+" phrase"+(a>1?"s":""))},delete:function(t){var e="",a=0;$(".content>.entity").length?(e="deleteEntity",a=t.closest(".entity").attr("data-id")):$(".content>.chapter").length&&(e="deleteChapter",a=$("#overlay").find(".content>.chapter").attr("data-id")),alertify.confirm("Confirmer la suppression?",function(){$.get("_.php",{f:e,id:a},function(){PROJECT.updateEntities(),PROJECT.refreshStory(),closeOverlay()})})},nav:function(t){var e=$('.tile[data-id="'+$("#overlay>.panel>.content .chapter").attr("data-id")+'"]'),a=e.attr("data-id");t.hasClass("next")&&e.next().length?a=e.next().attr("data-id"):t.hasClass("prev")&&e.prev().length&&(a=e.prev().attr("data-id")),EDITOR.openChapter(a)},save:function(t){var e=$("#overlay>.panel>.content");if(e.children(".entity").length){var a=e.find(".notice.editable").html();$.post("_.php",{f:"saveEntity",entity_id:t,notice:a},function(){alertify.success("Contenu modifié")})}else if(e.children(".chapter").length){var n=e.find(".header.editable").text(),r=e.find(".editor.editable").html(),i=e.find(".place .dropdown").dropdown("get value"),o=e.find("input[name=y]").val(),l=e.find("input[name=m]").val(),c=e.find("input[name=d]").val(),s=e.find("input[name=h]").val(),d=e.find("input[name=i]").val();$.post("_.php",{f:"saveChapter",chapter_id:t,title:n,text:r,place:i,y:o,m:l,d:c,h:s,i:d},function(){EDITOR.updateStats(),alertify.success("Contenu modifié")})}}},OPTIONS={open:function(){$.get("_.php",{f:"getOptionsOverlay"},function(t){$("#overlay>.panel>header>h1").html("Propriétés et Versions"),$("#overlay>.panel>.content").html(t),$("#overlay").fadeIn(),$("#overlay").on("click touchdown",".button.deleteVersion",function(t){t.preventDefault();var e=$(this).closest("a").attr("data-id");alertify.confirm("Supprimer cette version ?",function(){$.get("_.php",{f:"deleteVersion",id:e},function(){OPTIONS.open()})})}),$("#overlay #bNewVersion").on("click touchdown",function(){$("#overlay>.panel>.content").html('<div class="ui active dimmer"><div class="ui indeterminate text loader">Sauvegarde en cours…</div></div>'),$.get("_.php",{f:"newVersion"},function(){OPTIONS.open()})}),$("#overlay #bSave").on("click touchdown",function(){OPTIONS.save(),closeOverlay()})})},save:function(){var t=$("#overlay>.panel>.content");$.get("_.php",{f:"saveOptions",author:t.find("input[name=author]").val(),title:t.find("input[name=title]").val(),summary:t.find("input[name=summary]").val()},function(){alertify.success("Modifications enregistrées")})}},PUBLISH={open:function(){$.get("_.php",{f:"getPublishOverlay"},function(t){$("#overlay>.panel>header>h1").html("Options de publication"),$("#overlay>.panel>.content").html(t),$("#overlay .ui.accordion").accordion({exclusive:!1});var e=$("#overlay .pictureSelector");e.find("td>img.ui.image").click(function(){var t=$(this),a=t.hasClass("sel");e.find("td>img.ui.image").removeClass("sel"),a||t.addClass("sel"),$("#overlay").find("input[name=icon]").val(t.attr("src"))}),$("#overlay").fadeIn(),$("#overlay>.panel>.content .button.primary").on("click touchdown",function(){PUBLISH.publish()})})},publish:function(){var t=$("#overlay>.panel>.content"),e={f:"publishProject",author:t.find("input[name=author]").val(),title:t.find("input[name=title]").val(),summary:t.find("textarea[name=summary]").val()};t.find(".pictureSelector .image.sel").length&&(e.icon=t.find(".pictureSelector .image.sel").attr("src")),t.html('<div class="ui active dimmer"><div class="ui indeterminate text loader">Envoi en cours…</div></div>'),$.post("_.php",e,function(t){$("#overlay>.panel>.content").html(t)})}},PROJECT={init:function(){$("#extractEntities").length?$.ajax({url:"_importbook.php?file="+$("#extractEntities").attr("data-file"),type:"GET",success:function(){$("#extractEntities").fadeOut(),PROJECT.refreshStory(),PROJECT.updateEntities()},error:function(){alertify.error("Echec! L’analyse a échoué. Veuillez réessayer plus tard ou avec un autre livre."),$("#extractEntities").fadeOut()}}):(PROJECT.refreshStory(),PROJECT.updateEntities()),$(".ui.accordion").accordion({exclusive:!1}),$(".ui.dropdown").dropdown({on:"hover"}),PROJECT.initRangeInputs(0,-1),$(document).on("click touchdown","#menuOptions",function(){OPTIONS.open()}),$(document).on("click touchdown","#menuPublier",function(){PUBLISH.open()}),$(document).on("click",".entityManager .ui.label",function(){var t=parseInt($(this).attr("data-id"),10);if(0===t){var e=$(this).attr("data-class");alertify.prompt("Nouvelle entité","Nom",function(t,a){$.ajax({url:"_.php",method:"GET",dataType:"html",async:!1,data:{f:"newEntity",name:a,class:e},success:function(t){EDITOR.openEntity(t),PROJECT.updateEntities()}})})}else EDITOR.openEntity(t)}),$(document).on("click","#overlay,#overlay>.panel>header .remove",function(t){t.target===this&&(closeOverlay(),PROJECT.refreshStory())}),$(document).on("click","#overlay .button.delete",function(){EDITOR.delete($(this))}),$(document).on("click","#overlay .button.prev, #overlay .button.next",function(){EDITOR.nav($(this))}),$(document).on("click",".colorSelector .ui.label",function(){if(!$(this).hasClass("active")){var t=$(this).attr("data-color"),e="color_"+t,a=$(this).closest(".entity").attr("data-id");$(".colorSelector .ui.label").removeClass("active"),$(".colorSelector .ui.label."+e).addClass("active"),$(".ui.label[data-id="+a+"]").removeClass(function(t,e){return(e.match(/(^|\s)color_\S+/g)||[]).join(" ")}),$(".ui.label[data-id="+a+"]").addClass(e),$.ajax({url:"_.php",method:"GET",dataType:"html",data:{f:"changeColorEntity",entity_id:a,color:t},success:function(){alertify.success("Couleur changée avec succès"),GRAPHS.updateEntityNgram(a,t),PROJECT.refreshStory()}})}}),$(document).on("click",".buttons.type .button",function(){if(!$(this).hasClass("black")){var t=$(this).closest(".entity").attr("data-id"),e=$(this).attr("data-type");$(".buttons.type .button").removeClass("black"),$(this).addClass("black"),$.ajax({url:"_.php",method:"GET",dataType:"html",data:{f:"changeTypeEntity",entity_id:t,type:e},success:function(){PROJECT.refreshStory(),PROJECT.updateEntities(),GRAPHS.updateTimelineGraph(),alertify.success("Type changé avec succès")}})}}),$(document).on("change","#cbIncludeNonColored",function(){GRAPHS.updateTimelineGraph(),GRAPHS.updateCharsGraph(),GRAPHS.updateIOGraph()})},initRangeInputs:function(t,e){$(".ui.double.range").each(function(){var a=$(this);if(a.find(".labels>.label").length){var n=a.find(".labels>.label").length+1;e===-1&&(e=n),a.range({min:0,max:n,start:t,doubleStart:e,onChange:function(){GRAPHS.rangeInputChanged()}})}})},initSortableDraggable:function(){$(":ui-sortable").sortable("destroy"),$(":ui-draggable").draggable("destroy"),$(".zone .chapterList").sortable({items:".tile",containment:"parent",receive:function(t,e){e.sender.remove();var a={},n=1;$(".zone.structure .chapterList").each(function(){a[n++]=$(this).find(".tile").map(function(){return $(this).attr("data-id")}).get().join(",")}),$.ajax({url:"_.php",method:"GET",dataType:"html",async:!1,data:{f:"saveStory",story:a},success:function(){PROJECT.refreshStory()}})}}),$(".tile").draggable({connectToSortable:".zone .chapterList",helper:"clone",start:function(){$(this).hide()},stop:function(){$(this).show()}}),$(".tile").on("click touchdown",function(){var t=parseInt($(this).attr("data-id"),10);0===t?alertify.prompt("Nouveau chapitre","Titre",function(t,e){$.ajax({url:"_.php",method:"GET",dataType:"html",async:!1,data:{f:"newChapter",name:e,number:$(".zone.stock").find(".tile").length-1},success:function(t){EDITOR.openChapter(t),PROJECT.refreshStory()}})}):EDITOR.openChapter(t)})},refreshStory:function(){GRAPHS.updateTimelineGraph(),GRAPHS.updateCharsGraph(),GRAPHS.updateIOGraph(),$.ajax({url:"_.php",method:"GET",dataType:"html",async:!1,data:{f:"loadStory"},success:function(t){$(".zone.structure").html(t)}}),$.ajax({url:"_.php",method:"GET",dataType:"html",async:!1,data:{f:"loadStock"},success:function(t){$(".zone.stock").html(t)}}),PROJECT.initSortableDraggable()},updateEntities:function(){$.getJSON("_.php",{f:"getEntities"},function(t){var e=["character","place","other"];e.forEach(function(e){$(".entityManager .zone."+e).find(".label").remove(),e in t&&t[e].forEach(function(t){var a='<div class="labelDetails ui card"><div class="content"><i class="comment icon"></i> Cité '+t.citations+' fois</div><div class="extra content">Cliquez pour éditer...</div></div>';$(".entityManager .zone."+e).append('<a class="ui label entity color_'+t.color+'" data-id="'+t.id+'">'+t.name+a+"</a>")}),$(".entityManager .zone."+e).append('<a class="ui label color_0" data-id="0" data-class="'+e+'"><i class="icon add"></i></a>')})})}};$(document).ready(function(){PROJECT.init(),alertify.defaults.glossary.title="",alertify.defaults.glossary.ok="Confirmer",alertify.defaults.glossary.cancel="Annuler"}),$(window).resize(function(){$.debounce(500,function(){GRAPHS.updateTimelineGraph(),GRAPHS.updateCharsGraph(),GRAPHS.updateIOGraph()})});